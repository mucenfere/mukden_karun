<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Historical Map of Qing Manchu</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.groupedlayercontrol/dist/leaflet.groupedlayercontrol.min.css" />
  <script src="https://unpkg.com/leaflet.groupedlayercontrol/dist/leaflet.groupedlayercontrol.min.js"></script>
  
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .leaflet-tooltip.plain-label {
    background: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
    margin: 0;
    color: #000;
    font-size: 12px;
    font-weight: 600;
    text-shadow: 0 0 2px #fff, 0 0 2px #fff;
  }
  .leaflet-tooltip.plain-label:before {
    display: none !important;
  }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  const map = L.map('map').setView([41.8, 123.4], 7);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
});

  const satellite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  {
    maxZoom: 19,
    attribution: '&copy; Esri'
  }
);
  const labels = L.tileLayer(
  'https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
  { maxZoom: 19, attribution: '&copy; Esri' }
);

  satellite.addTo(map);
  labels.addTo(map); 

  async function loadGeoJSON(url, options = {}) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Failed to fetch ${url} (HTTP ${res.status})`);
  const gj = await res.json();

  return L.geoJSON(gj, {
    style: options.style,
    pointToLayer: options.pointToLayer,
    onEachFeature: (feature, layer) => {
      const p = feature.properties || {};
      const labelText =
        p.NAME_FT || p.NAME_CH || p.NAME_PY || p.name || p.name_ko || p.name_zh || '정보';

      layer.bindPopup(`<b>${labelText}</b>`);

      if (options.label === true && layer instanceof L.CircleMarker) {
        layer.bindTooltip(labelText, {
          permanent: true,
          direction: 'top',
          offset: [0, -6],
          opacity: 1,
          className: 'plain-label'
        });
      }
    }
  });
}
  (async () => {
    const admin = await loadGeoJSON('./data/admin.geojson', { style: { weight: 2, fillOpacity: 0.1 }});
    const chgisprov_pgn = await loadGeoJSON('./data/v6_1820_prov_pgn.geojson', { style: { weight: 2, fillOpacity: 0.1 }});
    const chgispref_pgn = await loadGeoJSON('./data/v6_1820_pref_pgn.geojson', { style: { weight: 2, fillOpacity: 0.1 }});
    const chgispref_pts = await loadGeoJSON('./data/v6_1820_pref_pts.geojson', { style: { weight: 2, fillOpacity: 0.1 }});
    const chgistwn_pts = await loadGeoJSON('./data/v6_1820_twn_pts.geojson', {
     label: true,
     pointToLayer: (f, latlng) => L.circleMarker(latlng, {
    radius: 4,
    color: '#000000',
    weight: 1,
    fillColor: '#000000',
    fillOpacity: 1
  })
});
    const roads = await loadGeoJSON('./data/roads.geojson', { style: { weight: 3 }});
    const wpkangxi = await loadGeoJSON('./data/willowpalisade-kangxi.geojson', { style: { weight: 3 }});
    const wpqianlong = await loadGeoJSON('./data/willowpalisade-qianlong.geojson', { style: { weight: 3 }});
    const cities = await loadGeoJSON('./data/cities.geojson', {
      pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 5, weight: 2, fillOpacity: 0.7 })
    });

    admin.addTo(map);
    cities.addTo(map);
    roads.addTo(map);

    const baseLayers = { "위성": satellite, "OSM": osm };

    const groupedOverlays = {
      "유조변": {
        "유조변(강희-옹정)": wpkangxi,
        "유조변(건륭)": wpqianlong
      },
      "참고자료_CHGIS (1820)": {
        "省 경계선(1820_CHGIS)": chgisprov_pgn,
        "府 경계선(1820_CHGIS)": chgispref_pgn,
        "府 치소(1820_CHGIS)": chgispref_pts,
        "지명(1820_CHGIS)": chgistwn_pts
      },
      "기타": {
        "행정/경계": admin,
        "교통로": roads,
        "도시": cities
      }
    };
console.log("groupedLayers exists?", typeof L.control.groupedLayers);
L.control.groupedLayers(baseLayers, groupedOverlays, { collapsed: false }).addTo(map);
  })().catch(err => { console.error(err); alert(err.message || err); });
</script>
</body>
</html>
